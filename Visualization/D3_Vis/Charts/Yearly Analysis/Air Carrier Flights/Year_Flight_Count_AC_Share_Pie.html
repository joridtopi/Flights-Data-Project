<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title> </title>
		<script type="text/javascript" src="../../../D3 Lib/d3.js"></script>
		<style type="text/css">

			p {
				font-family: Helvetica, sans-serif;
				font-size: 14px;
			}

			text {
				font-family: sans-serif;
				font-size: 12px;
				fill: white;
			}

			#tooltip {
				position: absolute;
				width: 200px;
				height: auto;
				padding: 10px;
				background-color: white;
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;
				border-radius: 10px;
				-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				pointer-events: none;
			}

			#tooltip.hidden {
				display: none;
			}

			#tooltip p {
				margin: 0;
				font-family: sans-serif;
				font-size: 16px;
				line-height: 20px;
			}

		</style>
	</head>
	<body>
		<p>
			<b>Description:</b> <br>This chart displays the proportion of total yearly flights for each recorded carrier on the selected year in a pie format.
		<br><br>
			<b>Guide:</b> <br>Select any year between 1987 and 2019, then click on the "Get Chart" button to obtain the graphic.
		<br><br>
			<b>Features:</b> <br>Hover over any wedge of the pie to obtain more details on that observation.
		<br><br>
		<b>User Inputs:</b>
		<br>Select Year:
		<input type="number" id="inputYear" min="1988" max="2019" step="1" value = "2019"/>
		<button>Get Chart</button>
		</p>

		<div id="tooltip" class="hidden">
			<p><strong>Air Carrier:</strong></p>
			<p><span id="airlineDisp">100</span></p>
			<p><strong>Proportion of Flights:</strong></p>
			<p><span id="propDisp">100</span></p>
			<p><strong>Number of Flights:</strong></p>
			<p><span id="countDisp">100</span></p>
			<p><strong>Year:</strong></p>
			<p><span id="yearDisp">100</span></p>
		</div>

		<script type="text/javascript">

			//Width and height
			var w = 1000;
			var h = 700;

			//Inner and outer radius for pie chart wedges
			var outerRadius = h / 2;
			var innerRadius = 0;
			var arc = d3.arc()
						.innerRadius(innerRadius)
						.outerRadius(outerRadius);

			//Declaration of pie function
			var pie = d3.pie();

			//Easy colors accessible via a 10-step ordinal scale
			var color = d3.scaleOrdinal(d3.schemeCategory10);

			//Used for test during development
			var testdata = [];

			//Data path
			const airline_flight_count_data = '../../../JSON_data/Yearly Analysis/Air Carrier Flights/Total_Flights_Year_Table_Ac.json';

			//Create event to listen for user input clicks to update data
			d3.selectAll('button')
				.on("click", updateCharts);


			function updateCharts(){

				//Fetch user input year
				input_year = document.getElementById('inputYear').value;

				//Read in data
				d3.json(airline_flight_count_data )
				.then(function(dataset) {

					//Clear current charts
					d3.selectAll("svg").remove();

					//Convert count to numeric
					dataset.forEach(function(d){
						d.count = +d.num_sched_flights_year;
					});

					//Create filtered datasets based on user input
					dataset = dataset.filter(d=>d.fl_year==input_year);

					//Create arrays of data to be added after the pie transformation
					airline_flight_count_array = dataset.map(item => item.count);
					airline_name_array = dataset.map(item => item.carrier_name);

					//Transform flight count data to pie values
					flight_count_pie = pie(airline_flight_count_array);

					//Obtain total sum of all flights
					total_flight_count = airline_flight_count_array.reduce(function (a, b) {
	    			return a + b;
					});

					//Add carrier name and carrier flight proportion to the processed pie data for text displays
					for (let i = 0; i < flight_count_pie.length; i++) {
	 						flight_count_pie[i].carrier_name = airline_name_array[i];
							carrier_prop = (airline_flight_count_array[i]/total_flight_count)*100;
							flight_count_pie[i].carrier_prop = Math.round(carrier_prop * 100) / 100;
					};

					testdata = dataset;
					//Create SVG element
					var svg = d3.select("body")
								.append("svg")
								.attr("width", w)
								.attr("height", h);

					//Set up groups
					var arcs = svg.selectAll("g.arc")
								  .data(flight_count_pie)
								  .enter()
								  .append("g")
								  .attr("class", "arc")
									.attr("stroke", "whitesmoke")
								  .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")")
									.on("mouseover", function(d){

										//Update the tooltip position, values and text
										d3.select("#tooltip")
											.style("top", (d3.event.pageY - 10) + "px")
											.style("left", (d3.event.pageX + 10) + "px")
											.select("#airlineDisp")
											.text(d.carrier_name);

										d3.select("#tooltip")
											.select("#countDisp")
											.text(d.value);

										d3.select("#tooltip")
											.select("#propDisp")
											.text(d.carrier_prop+"%");

										d3.select("#tooltip")
											.select("#yearDisp")
											.text(input_year);

										//Show the tooltip
										d3.select("#tooltip").classed("hidden", false);
									})
									.on("mouseout", function(d){

				 						//Hide the tooltip
				 						d3.select("#tooltip").classed("hidden", true);
								});

					//Draw arc paths
					arcs.append("path")
					    .attr("fill", function(d, i) {
					    	return color(i);
					    })
					    .attr("d", arc);

					//Labels
					arcs.append("text")
					    .attr("transform", function(d) {
					    	return "translate(" + arc.centroid(d) + ")";
					    })
					    .attr("text-anchor", "middle")
					    .text(function(d) {
					    	return d.carrier_prop;
					    });


				var legendG = svg.selectAll(".legend") // note appending it to mySvg and not svg to make positioning easier
				  .data(flight_count_pie)
				  .enter().append("g")
				  .attr("transform", function(d,i){
				    return "translate(" + (w - 210) + "," + (i * 15 + 20) + ")"; // place each legend on the right and bump each one down 15 pixels
				  })
				  .attr("class", "legend");


				legendG.append("rect") // make a matching color rect
				  .attr("width", 10)
				  .attr("height", 10)
				  .attr("fill", function(d, i) {
				    return color(i);
				  });

				legendG.append("text") // add the text
				  .text(function(d){
				    return d.carrier_name;
				  })
				  .style("font-size", 12)
					.style("fill", function(d, i) {
				    return color(i);
				  })
				  .attr("y", 10)
				  .attr("x", 11);

				});
			};

		</script>
	</body>
</html>
